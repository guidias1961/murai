import React, { useEffect, useMemo, useRef, useState } from "react";

// ============================================
// MURAI • Muraiverso NFT Site (Basechain)
// Single file React component. Put logo.png and nft1.png..nft20.png in the same folder or /public.
// No external libs required. Tailwind classes used for styling.
// ============================================

const NFT_COUNT = 20;
const NFT_PATHS = Array.from({ length: NFT_COUNT }, (_, i) => `nft${i + 1}.png`);

const TAGLINES = [
  "Alpha dojo, no whining.",
  "Basechain or nothing.",
  "Hold $MURAI and become a pump sensei.",
  "Half wisdom, half meme, 100% liquidity.",
  "Roadmap: train, laugh, raid, repeat.",
  "The Muraiverse is multiform, gas is low.",
  "Shh, the pigeon is teaching DeFi.",
  "Samurai honor, degen volatility.",
  "Pigeon with a katana and a PnL sheet.",
  "You called? Sensei drops alpha on the chalkboard."
];

const LORE = [
  "Murai was born in the alley where hash meets honor.",
  "Every Murai variation is a parallel universe with different leverage.",
  "The dojo lives on Basechain and the chalkboard is on-chain.",
  "Apprentices receive quests, raids, and utility memes.",
  "The katana cuts fees. The wings carry liquidity.",
  "The pigeon-sensei watches wallets and rewards discipline.",
  "Try to rug and you get the eraser to the forehead."
];

function useKonami(callback: () => void) {
  useEffect(() => {
    const seq = ["ArrowUp","ArrowUp","ArrowDown","ArrowDown","ArrowLeft","ArrowRight","ArrowLeft","ArrowRight","b","a"];
    let idx = 0;
    const onKey = (e: KeyboardEvent) => {
      if ((e.key || "").toLowerCase() === seq[idx].toLowerCase()) {
        idx += 1;
        if (idx === seq.length) { callback(); idx = 0; }
      } else { idx = 0; }
    };
    window.addEventListener("keydown", onKey);
    return () => window.removeEventListener("keydown", onKey);
  }, [callback]);
}

function Chalkboard({ text }: { text: string }) {
  const canvasRef = useRef<HTMLCanvasElement | null>(null);
  const [progress, setProgress] = useState(0);

  // Animation loop
  useEffect(() => {
    let raf = 0;
    const step = () => { setProgress(p => Math.min(1, p + 0.01)); raf = requestAnimationFrame(step); };
    raf = requestAnimationFrame(step);
    return () => cancelAnimationFrame(raf);
  }, []);

  useEffect(() => {
    const c = canvasRef.current; if (!c) return;
    const ctx = c.getContext("2d"); if (!ctx) return;

    const DPR = Math.max(1, Math.floor(window.devicePixelRatio || 1));
    const W = c.clientWidth * DPR; const H = c.clientHeight * DPR;
    c.width = W; c.height = H;

    // Board background
    ctx.fillStyle = "#223b2f"; // chalkboard green
    ctx.fillRect(0, 0, W, H);

    // Wooden frame
    ctx.fillStyle = "#8b5a2b";
    ctx.fillRect(0, 0, W, 20 * DPR);
    ctx.fillRect(0, H - 20 * DPR, W, 20 * DPR);
    ctx.fillRect(0, 0, 20 * DPR, H);
    ctx.fillRect(W - 20 * DPR, 0, 20 * DPR, H);

    // Chalk text writing effect
    const pad = 50 * DPR;
    const fontSize = Math.min(96 * DPR, W / 8);
    ctx.save();
    ctx.beginPath();
    ctx.rect(pad, pad, (W - pad * 2) * progress, fontSize + 10 * DPR);
    ctx.clip();
    ctx.font = `bold ${fontSize}px system-ui, -apple-system, Segoe UI, Roboto`;
    ctx.fillStyle = "#f2f2f2";
    ctx.shadowColor = "rgba(255,255,255,.6)"; ctx.shadowBlur = 4 * DPR;
    ctx.fillText(text, pad, pad + fontSize);
    ctx.restore();

    // Mini chart: fake candles
    const chartX = pad; const chartY = pad + fontSize + 50 * DPR;
    const chartW = W - pad * 2; const chartH = H - chartY - pad;
    const candles = 36; const cw = chartW / candles;
    const seed = 1337;
    let r = seed;
    const rand = () => { r = (r * 48271) % 2147483647; return r / 2147483647; };

    // Grid
    ctx.strokeStyle = "rgba(255,255,255,.07)"; ctx.lineWidth = 1 * DPR;
    for (let i = 0; i <= 6; i++) {
      const y = chartY + (i * chartH) / 6; ctx.beginPath(); ctx.moveTo(chartX, y); ctx.lineTo(chartX + chartW, y); ctx.stroke();
    }

    // Candles
    for (let i = 0; i < candles; i++) {
      const base = chartY + chartH * 0.1 + rand() * chartH * 0.8;
      const high = base - rand() * 48 * DPR; const low = base + rand() * 48 * DPR;
      const open = base + (rand() - 0.5) * 24 * DPR; const close = base + (rand() - 0.5) * 24 * DPR;
      const x = chartX + i * cw + cw * 0.5;
      // Wick
      ctx.strokeStyle = "#e6e6e6"; ctx.lineWidth = 2 * DPR; ctx.beginPath(); ctx.moveTo(x, high); ctx.lineTo(x, low); ctx.stroke();
      // Body
      ctx.fillStyle = close < open ? "#2ecc71" : "#e74c3c";
      const y = Math.min(open, close); const h = Math.max(2 * DPR, Math.abs(open - close));
      ctx.fillRect(x - cw * 0.25, y, cw * 0.5, h);
    }

    // Side notes
    ctx.fillStyle = "#f2f2f2"; ctx.font = `${14 * DPR}px system-ui`;
    ctx.fillText("basechain liquidity dojo", chartX, chartY - 12 * DPR);
  }, [progress, text]);

  return <canvas ref={canvasRef} className="w-full h-[420px] rounded-2xl shadow-inner" />;
}

function usePreload(urls: string[]) {
  const [ready, setReady] = useState(false);
  useEffect(() => {
    let done = 0; const imgs: HTMLImageElement[] = [];
    urls.forEach(u => { const im = new Image(); im.onload = () => { done++; if (done === urls.length) setReady(true); }; im.onerror = () => { done++; if (done === urls.length) setReady(true); }; im.src = u; imgs.push(im); });
    return () => imgs.forEach(i => (i.onload = null));
  }, [urls]);
  return ready;
}

function RandomLore() {
  const phrase = useMemo(() => {
    const pick = (arr: string[]) => arr[Math.floor(Math.random() * arr.length)];
    return `${pick(LORE)} ${pick(TAGLINES)}`;
  }, []);
  return <p className="text-sm text-white/80">{phrase}</p>;
}

function GridNFTs() {
  const [order, setOrder] = useState(NFT_PATHS);
  const [active, setActive] = useState<string | null>(null);

  function onShuffle() {
    setOrder(prev => [...prev].sort(() => Math.random() - 0.5));
  }

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <h3 className="text-xl font-semibold tracking-tight">Dojo Gallery</h3>
        <div className="flex gap-2">
          <button onClick={onShuffle} className="px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20 transition">shuffle</button>
          <button onClick={() => setActive(order[Math.floor(Math.random() * order.length)])} className="px-3 py-2 rounded-xl bg-cyan-500 hover:bg-cyan-400 text-black font-semibold">summon random</button>
        </div>
      </div>

      <div className="grid md:grid-cols-4 grid-cols-2 gap-3">
        {order.map((src) => (
          <button key={src} onClick={() => setActive(src)} className="group relative aspect-square overflow-hidden rounded-2xl bg-gradient-to-br from-slate-800 to-slate-900 ring-1 ring-white/10">
            <img src={src} alt={src} className="absolute inset-0 w-full h-full object-contain p-3 group-hover:scale-105 transition" />
            <span className="absolute bottom-2 right-2 text-[10px] uppercase tracking-widest bg-black/60 px-2 py-1 rounded-md">{src.replace(".png", "")}</span>
          </button>
        ))}
      </div>

      {active && (
        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 grid place-items-center p-4" onClick={() => setActive(null)}>
          <div className="relative max-w-5xl w-full bg-neutral-900 rounded-3xl ring-1 ring-white/10 p-4 md:p-6" onClick={(e) => e.stopPropagation()}>
            <button onClick={() => setActive(null)} className="absolute top-3 right-3 bg-white/10 hover:bg-white/20 rounded-full px-3 py-1">close</button>
            <div className="grid md:grid-cols-2 gap-6 items-center">
              <img src={active} alt="nft" className="w-full h-full object-contain rounded-2xl" />
              <div className="space-y-3">
                <h4 className="text-2xl font-bold">Form {active.replace(/\D/g, "").padStart(2, "0")}</h4>
                <RandomLore />
                <p className="text-white/70 text-sm">This Murai form embodies a Muraiverse archetype. Collect, compare, and create combos with social rarities. Click outside to close.</p>
                <div className="flex gap-2">
                  <a href="#buy" className="px-4 py-2 rounded-xl bg-cyan-500 hover:bg-cyan-400 text-black font-semibold">buy later</a>
                  <button onClick={() => window.alert("screenshot mental feito") } className="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20">take mental screenshot</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

function DojoHeader({ neonMode, setNeonMode }: { neonMode: boolean; setNeonMode: (b: boolean) => void }) {
  const [tag, setTag] = useState(0);
  useEffect(() => { const id = setInterval(() => setTag(t => (t + 1) % TAGLINES.length), 2500); return () => clearInterval(id); }, []);
  return (
    <header className="relative overflow-hidden rounded-3xl bg-gradient-to-br from-slate-900 via-slate-950 to-black p-6 md:p-10 ring-1 ring-white/10">
      <div className="absolute -top-24 -left-24 w-72 h-72 rounded-full bg-cyan-500/20 blur-3xl" />
      <div className="absolute -bottom-24 -right-24 w-72 h-72 rounded-full bg-fuchsia-500/20 blur-3xl" />
      <div className="relative flex flex-col md:flex-row items-center gap-6">
        <img src="logo.png" alt="$MURAI logo" className="w-28 h-28 md:w-36 md:h-36 object-contain drop-shadow-[0_0_30px_rgba(0,255,200,.3)]" />
        <div className="flex-1 space-y-2">
          <h1 className="text-4xl md:text-6xl font-black tracking-tight">Murai $MURAI</h1>
          <p className="text-white/70 max-w-2xl">Welcome to the Muraiverse. Samurai pigeons teaching crypto with humor and discipline. Deployed on Basechain. Learn in the dojo. Meme on the feed. Liquidity in our veins.</p>
          <p className="text-cyan-300/90 text-sm">{TAGLINES[tag]}</p>
        </div>
        <div className="flex gap-2">
          <a href="#buy" className="px-4 py-2 rounded-xl bg-cyan-500 hover:bg-cyan-400 text-black font-semibold">buy</a>
          <button onClick={() => setNeonMode(!neonMode)} className="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20">{neonMode ? "turn neon off" : "turn neon on"}</button>
        </div>
      </div>
    </header>
  );
}

export default function App() {
  const ready = usePreload(["logo.png", ...NFT_PATHS]);
  const [neonMode, setNeonMode] = useState(false);
  const [dojoOpen, setDojoOpen] = useState(true);

  useKonami(() => setNeonMode(v => !v));

  return (
    <main className={`${neonMode ? "[filter:contrast(110%)_saturate(125%)]" : ""} text-white min-h-screen bg-[#0a0c10]`}> 
      {/* Ticker meme */}
      <div className="sticky top-0 z-40 bg-black/60 backdrop-blur border-b border-white/10">
        <div className="animate-marquee whitespace-nowrap text-xs py-2">
          <span className="mx-6">Basechain dojo open</span>
          <span className="mx-6">$MURAI is not financial advice</span>
          <span className="mx-6">Sensei only accepts payments in laughter</span>
          <span className="mx-6">Click the logo for random luck</span>
        </div>
      </div>

      <div className="max-w-7xl mx-auto p-4 md:p-8 space-y-10">
        <DojoHeader neonMode={neonMode} setNeonMode={setNeonMode} />

        <section className="grid md:grid-cols-2 gap-6 items-start">
          <div className="space-y-4">
            <h2 className="text-2xl font-bold">Sensei's Chalkboard</h2>
            <Chalkboard text="BASECHAIN" />
            <p className="text-white/70 text-sm">The board writes by itself while the market breathes. The candles are illustrative; the class is real. Press M for meme mode.</p>
          </div>
          <div className="space-y-4">
            <h2 className="text-2xl font-bold">Muraiverse Lore</h2>
            <div className="rounded-2xl ring-1 ring-white/10 bg-white/5 p-4 leading-relaxed">
              <p>Murai é um mestre de universos paralelos. Em cada timeline, ele surge com uma forma diferente e uma lição nova. No Muraiverso, cada NFT representa uma técnica. Colecionar é estudar. Raidar é treinar. Vencer é manter a calma enquanto o resto do mundo panica.</p>
              <p className="mt-3"><RandomLore /></p>
            </div>
            <div className="flex flex-wrap gap-2">
              <a id="buy" href="#" className="px-4 py-2 rounded-xl bg-cyan-500 hover:bg-cyan-400 text-black font-semibold">buy on Basechain</a>
              <a href="#" className="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20">view contract</a>
              <a href="#gallery" className="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20">open gallery</a>
            </div>
          </div>
        </section>

        <section id="gallery" className="space-y-4">
          <GridNFTs />
        </section>

        <footer className="pt-10 pb-16 text-center text-white/50">
          <p>Murai $MURAI • Muraiverse on Basechain</p>
          <p className="text-xs">Generative art with a handmade vibe. This site is 100% functional meme.</p>
        </footer>
      </div>

      {/* Styles */}
      <style>{`
        .animate-marquee { 
          animation: marquee 22s linear infinite; 
        }
        @keyframes marquee { from { transform: translateX(0); } to { transform: translateX(-50%); } }
      `}</style>

      {!ready && (
        <div className="fixed inset-0 grid place-items-center bg-black/80">
          <div className="text-center">
            <div className="w-10 h-10 border-2 border-white/20 border-t-white/80 rounded-full animate-spin mx-auto mb-3" />
            <p className="text-white/70">loading dojo</p>
          </div>
        </div>
      )}
    </main>
  );
}

